# RAMS Kinetic Table — Hardware Architecture v2.0

## 1. System Overview

```
┌──────────────┐    UDP/WiFi     ┌─────────┐   Serial1   ┌───────────┐   Relay    ┌──────────────┐
│  Windows App │ ──────────────> │  ESP32  │ ──────────> │  Mega #1  │ ────────> │ Blocks 1–8   │
│  (Next.js +  │    Port 4210   │         │             │ (16 pins) │           │ (16 actuators)│
│   Electron)  │                │  LED    │   Serial2   ├───────────┤           └──────────────┘
└──────────────┘                │  Master │ ──────────> │  Mega #2  │   Relay    ┌──────────────┐
                                │         │             │ (14 pins) │ ────────> │ Blocks 9–15  │
                                └─────────┘             └───────────┘           │ (15 actuators)│
                                    │                                           └──────────────┘
                                    │ GPIO 23
                                    ▼
                              ┌───────────┐
                              │ WS2812B   │
                              │ LED Strip │
                              │ (12V)     │
                              └───────────┘
```

---

## 2. Block & Actuator Map

Платформа — круг с двумя кольцами + центр (см. SketchUp модель).

### Внешнее кольцо (7 секторов)
| Block | Кольцо   | Актуаторов | Mega  |
|-------|----------|------------|-------|
| 1     | Внешнее  | 2          | #1    |
| 2     | Внешнее  | 2          | #1    |
| 3     | Внешнее  | 2          | #1    |
| 4     | Внешнее  | 2          | #1    |
| 5     | Внешнее  | 2          | #1    |
| 6     | Внешнее  | 2          | #1    |
| 7     | Внешнее  | 2          | #1    |

### Внутреннее кольцо (7 секторов)
| Block | Кольцо     | Актуаторов | Mega  |
|-------|------------|------------|-------|
| 8     | Внутреннее | 2          | #1    |
| 9     | Внутреннее | 2          | #2    |
| 10    | Внутреннее | 2          | #2    |
| 11    | Внутреннее | 2          | #2    |
| 12    | Внутреннее | 2          | #2    |
| 13    | Внутреннее | 2          | #2    |
| 14    | Внутреннее | 2          | #2    |

### Центр
| Block | Кольцо | Актуаторов | Mega  |
|-------|--------|------------|-------|
| 15    | Центр  | 3          | #2    |

**Итого:** 14 × 2 + 1 × 3 = **31 актуатор**, **15 блоков**, **30 реле-каналов**

> Актуаторы внутри одного блока подключены **параллельно** к одной паре реле (H-Bridge).
> Они всегда двигаются вместе.

---

## 3. Relay Wiring (H-Bridge из 2 реле)

Каждый блок управляется **2-канальным реле модулем** в конфигурации H-Bridge.
Это позволяет менять полярность на актуаторе (вверх/вниз).

```
                    +12V (от PSU)                    GND (общий)
                        │                                │
                        ▼                                ▼
                   ┌────┴────┐                      ┌────┴────┐
                   │  NO(1)  │                      │  NC(2)  │
    Relay 1  ──────┤  COM(1) ├──── Motor Wire A ────┤  COM(2) ├────── Relay 2
                   │  NC(1)  │                      │  NO(2)  │
                   └────┬────┘                      └────┬────┘
                        │                                │
                        ▼                                ▼
                       GND                             +12V
```

### Логика управления

| Действие | Relay 1 (Pin UP) | Relay 2 (Pin DOWN) | Motor Wire A | Motor Wire B | Результат       |
|----------|------------------|--------------------|-------------|-------------|-----------------|
| **STOP** | OFF (NC)         | OFF (NC)           | GND         | GND         | Мотор стоит     |
| **UP**   | ON (NO)          | OFF (NC)           | +12V        | GND         | Мотор вверх     |
| **DOWN** | OFF (NC)         | ON (NO)            | GND         | +12V        | Мотор вниз      |
| **X**    | ON               | ON                 | +12V        | +12V        | **ЗАПРЕЩЕНО!** ⚠️ |

> **EDGE CASE #1 — Короткое замыкание:** Оба реле ON = оба провода на +12V, ток через мотор = 0 (нет разницы потенциалов), но **это опасно** для некоторых реле модулей. Код ОБЯЗАН предотвращать это состояние: перед включением одного реле — выключить другое + задержка 50мс (deadtime).

> **EDGE CASE #2 — Active LOW модули:** Большинство синих реле модулей (с оптопарой) работают **Active LOW**: `LOW = реле включено`, `HIGH = реле выключено`. Код должен поддерживать инверсию через `#define RELAY_ACTIVE_LOW true`.

### Параллельное подключение актуаторов в блоке

```
Relay COM(1) ──┬── Actuator_A Red Wire
               └── Actuator_B Red Wire    (для центрального блока — 3 провода)

Relay COM(2) ──┬── Actuator_A Black Wire
               └── Actuator_B Black Wire
```

> **EDGE CASE #3 — Неравная нагрузка:** Если один актуатор в блоке заклинит, второй продолжит двигаться. Это может перекосить панель. **Решение:** концевые выключатели (limit switches) на каждом актуаторе, или аварийный таймаут в коде.

---

## 4. Pin Assignments

### Arduino Mega #1 (Blocks 1–8)

| Block | Pin UP | Pin DOWN | Relay Module |
|-------|--------|----------|-------------|
| 1     | 22     | 23       | Module 1    |
| 2     | 24     | 25       | Module 2    |
| 3     | 26     | 27       | Module 3    |
| 4     | 28     | 29       | Module 4    |
| 5     | 30     | 31       | Module 5    |
| 6     | 32     | 33       | Module 6    |
| 7     | 34     | 35       | Module 7    |
| 8     | 36     | 37       | Module 8    |

**Serial1 (от ESP32):** RX1 = pin 19, TX1 = pin 18

### Arduino Mega #2 (Blocks 9–15)

| Block | Pin UP | Pin DOWN | Relay Module |
|-------|--------|----------|-------------|
| 9     | 22     | 23       | Module 9    |
| 10    | 24     | 25       | Module 10   |
| 11    | 26     | 27       | Module 11   |
| 12    | 28     | 29       | Module 12   |
| 13    | 30     | 31       | Module 13   |
| 14    | 32     | 33       | Module 14   |
| 15    | 34     | 35       | Module 15   |

**Serial1 (от ESP32):** RX1 = pin 19, TX1 = pin 18

### ESP32

| Функция              | GPIO |
|----------------------|------|
| Serial1 TX → Mega #1 | 17   |
| Serial1 RX ← Mega #1 | 16   |
| Serial2 TX → Mega #2 | 4    |
| Serial2 RX ← Mega #2 | 5    |
| LED Data Out (WS2812B)| 23  |
| Status LED (onboard) | 2    |

---

## 5. Power Distribution

5 БП по 12V / 40A = 200A суммарно.

```
┌─────────────────────────────────────────────────────────┐
│                   COMMON GND BUS                        │
│  ═══════════════════════════════════════════════════     │
│    │       │       │       │       │                     │
│  PSU1    PSU2    PSU3    PSU4    PSU5                    │
│  GND     GND     GND     GND     GND                    │
└─────────────────────────────────────────────────────────┘
```

> **EDGE CASE #4 — Общий GND:** Все 5 БП ОБЯЗАНЫ иметь общую землю (GND шина). Без этого логика управления не будет работать, возможны плавающие потенциалы и повреждение оборудования.

| PSU   | Назначение                          | Нагрузка (макс)              |
|-------|-------------------------------------|------------------------------|
| PSU 1 | Логика + LED                        | DC-DC 5V→Mega×2, ESP32, реле VCC. LED лента (12V прямое) |
| PSU 2 | Актуаторы блоков 1–4                | 4 блока × 2 акт × ~3A = 24A |
| PSU 3 | Актуаторы блоков 5–8                | 4 блока × 2 акт × ~3A = 24A |
| PSU 4 | Актуаторы блоков 9–12               | 4 блока × 2 акт × ~3A = 24A |
| PSU 5 | Актуаторы блоков 13–15              | 2 бл × 2 акт + 1 бл × 3 акт = 21A |

> **EDGE CASE #5 — Пусковой ток:** Актуаторы при старте потребляют в 2–3 раза больше номинала. Если все 31 актуатор стартует одновременно — пиковый ток может достигать 180A+. БП могут уйти в защиту.
> **Решение:** Команда `ALL:UP` в коде должна поднимать блоки **последовательно с задержкой 200–500мс** между блоками (staggered start).

### DC-DC преобразователь (для логики)

```
PSU1 (+12V) ──> [DC-DC Buck 12V→5V, мин 5A] ──> 5V шина
                                                    │
                                    ┌───────────────┼──────────────┐
                                    ▼               ▼              ▼
                                 Mega #1         Mega #2        ESP32
                                 (5V pin)        (5V pin)       (VIN 5V)
                                    │               │              │
                                    └───────┬───────┘              │
                                            ▼                      │
                                    Relay Module VCC (5V)          │
                                    (все 15 модулей)               │
```

> **EDGE CASE #6 — Питание реле модулей:** 15 модулей × 2 реле × ~70mA = ~2.1A только на катушки реле. DC-DC должен быть минимум **5A** (с запасом на Mega + ESP32).

---

## 6. Communication Protocol

### 6.1. Windows App → ESP32 (UDP, port 4210)

```
Формат:  COMMAND:PARAM[:PARAM2]
```

| Команда             | Описание                     |
|---------------------|------------------------------|
| `BLOCK:1:UP`        | Поднять блок 1               |
| `BLOCK:1:DOWN`      | Опустить блок 1              |
| `BLOCK:1:STOP`      | Остановить блок 1            |
| `BLOCK:15:UP`       | Поднять центральный блок     |
| `RING:OUTER:UP`     | Поднять все внешнее кольцо   |
| `RING:INNER:UP`     | Поднять все внутреннее       |
| `ALL:UP`            | Все вверх (staggered)        |
| `ALL:DOWN`          | Все вниз (staggered)         |
| `ALL:STOP`          | Аварийный стоп ВСЕХ          |
| `LED:MODE:RAINBOW`  | Сменить LED анимацию         |
| `LED:BLOCK:3:FF0000`| Подсветить блок 3 красным    |
| `LED:BRIGHTNESS:150`| Яркость 0–255               |
| `PING`              | Проверка связи               |
| `STATUS`            | Запрос состояния всех блоков |

### 6.2. ESP32 → Mega (Serial, 115200 baud)

ESP32 маршрутизирует команду на нужный Mega:

```
Blocks 1–8   → Serial1 (Mega #1)
Blocks 9–15  → Serial2 (Mega #2)
```

Формат тот же: `BLOCK:N:ACTION\n`

### 6.3. Mega → ESP32 (ответ)

```
ACK:BLOCK:1:UP        — команда принята и выполняется
ERR:BLOCK:1:TIMEOUT   — актуатор не ответил / таймаут
STATE:1:UP,2:STOP,... — полный статус (по запросу STATUS)
```

> **EDGE CASE #7 — Потеря связи WiFi:** ESP32 должен хранить последнее состояние. При потере WiFi — автоматический `ALL:STOP` через 5 секунд. При восстановлении — отправить текущий статус приложению.

> **EDGE CASE #8 — Гонка команд:** Если приходит `BLOCK:1:UP` а потом сразу `BLOCK:1:DOWN` — Mega ОБЯЗАН сначала выполнить STOP + deadtime 50мс перед сменой направления.

> **EDGE CASE #9 — Дублирование команд:** Если блок уже в состоянии UP и приходит повторная `UP` — игнорировать (не дергать реле).

---

## 7. LED Strip Layout (WS2812B 12V)

Лента идет вдоль серых разделительных линий между секторами.

```
                      LED STRIP PATH
                     (вдоль разделителей)
                           │
            ┌──────────────┼──────────────┐
            │          ╱   │   ╲          │
            │        ╱  ┌──┴──┐  ╲        │
            │      ╱    │ C15 │    ╲      │   C15 = Центр (Block 15)
            │    ╱      └──┬──┘      ╲    │
            │  ╱     Inner Ring        ╲  │
            │╱    8  9  10  11  12  13  14╲│
            │─────────────────────────────│
            │     Outer Ring              │
            │  1   2   3   4   5   6   7  │
            └─────────────────────────────┘
```

### Сегментация ленты

LED лента — одна непрерывная цепочка. Разбита на логические сегменты, каждый привязан к разделителю или зоне блока.

| Сегмент | LED start | LED count | Назначение                  |
|---------|-----------|----------|-----------------------------|
| 0       | 0         | 80       | Внешний обод (декор)        |
| 1       | 80        | 60       | Разделитель Block 1/2       |
| 2       | 140       | 60       | Разделитель Block 2/3       |
| 3       | 200       | 60       | Разделитель Block 3/4       |
| 4       | 260       | 60       | Разделитель Block 4/5       |
| 5       | 320       | 60       | Разделитель Block 5/6       |
| 6       | 380       | 60       | Разделитель Block 6/7       |
| 7       | 440       | 60       | Разделитель Block 7/1       |
| 8       | 500       | 50       | Внутреннее кольцо обод      |
| 9–15    | 550       | 40 each  | Разделители внутр. кольца   |
| 16      | 830       | 70       | Центральный круг            |

> Эти значения **приблизительные** — нужно замерить реальную длину каждого участка и обновить маппинг.

### LED анимации (по умолчанию)

По дефолту вся лента светится (idle-анимация). Варианты:
- `RAINBOW` — радужный бегущий градиент
- `PULSE` — медленное мигание одним цветом
- `STATIC` — статичный цвет
- `WAVE` — волна по кругу

Когда блок активируется (UP/DOWN), его сегменты подсвечиваются отдельным цветом/эффектом.

---

## 8. Voltage Level Shifting (ESP32 ↔ Mega)

ESP32 работает на **3.3V логике**, Mega на **5V**.

### ESP32 TX → Mega RX (3.3V → 5V)
Безопасно: 3.3V воспринимается Mega как HIGH (порог ~2.5V).
Доп. компоненты не нужны.

### Mega TX → ESP32 RX (5V → 3.3V) ⚠️
**ОПАСНО:** 5V может повредить ESP32!

**Решение — резистивный делитель:**
```
Mega TX ──[2.2kΩ]──┬──[3.3kΩ]── GND
                    │
                    └── ESP32 RX
```
Выход: 5V × 3.3 / (2.2 + 3.3) = **3.0V** — безопасно для ESP32.

> Нужно **2 делителя** — по одному на каждый Mega TX.

---

## 9. Safety & Edge Cases Summary

| #  | Edge Case                        | Решение                                              |
|----|----------------------------------|------------------------------------------------------|
| 1  | Оба реле ON (H-Bridge short)     | Код: STOP + 50мс deadtime перед сменой направления   |
| 2  | Active LOW реле модули           | Конфигурируемый `RELAY_ACTIVE_LOW` флаг              |
| 3  | Заклинивший актуатор             | Таймаут 15 сек — автостоп блока                      |
| 4  | Нет общей GND                    | Шина GND между ВСЕМИ 5 БП (толстый провод)           |
| 5  | Пусковой ток (все одновременно)  | Staggered start: 300мс задержка между блоками        |
| 6  | Недостаточно 5V для реле катушек | DC-DC минимум 5A                                     |
| 7  | Потеря WiFi                      | Auto-STOP через 5 сек, reconnect loop                |
| 8  | Быстрая смена направления        | Принудительный STOP + deadtime перед реверсом         |
| 9  | Дублирование команд              | Игнорировать если уже в нужном состоянии             |
| 10 | Потеря Serial связи ESP↔Mega     | Heartbeat каждые 2 сек, auto-STOP если нет ответа    |
| 11 | БП уходит в защиту               | Staggered start + предохранители на каждую группу    |
| 12 | Перегрев реле при длительной нагрузке | Таймаут движения 15 сек макс                    |
| 13 | LED лента — инжекция питания     | При длине > 5м подавать 12V каждые 5м               |
| 14 | ESP32 перезагрузка                | Mega при потере heartbeat → STOP все                 |

---

## 10. Bill of Materials (проверочный)

| Компонент                         | Кол-во | Назначение                |
|-----------------------------------|--------|---------------------------|
| ESP32 DevKit                      | 1      | WiFi + LED контроллер     |
| Arduino Mega 2560                 | 2      | Управление реле           |
| 2-канальный реле модуль 5V/10A    | 15     | H-Bridge для 15 блоков    |
| Линейный актуатор 12V             | 31     | Подъём/спуск панелей      |
| БП 12V 40A                        | 5      | Питание                   |
| DC-DC Buck 12V→5V (5A+)          | 1      | Логика                    |
| WS2812B лента 12V                 | ~40м   | Подсветка                 |
| Резистор 2.2kΩ                    | 2      | Делитель напряжения TX    |
| Резистор 3.3kΩ                    | 2      | Делитель напряжения TX    |
| Резистор 330Ω                     | 1      | LED data line             |
| Провода толстые (2.5мм²+)        | —      | Силовые линии             |
| Провода тонкие (дюпонт)          | —      | Сигнальные линии          |
| Предохранители 10A               | 15     | По одному на блок         |

---

## 11. Wiring Checklist

- [ ] Соединить GND всех 5 БП толстым проводом (шина)
- [ ] DC-DC от PSU1 → 5V → Mega×2, ESP32, реле VCC
- [ ] Mega1 Serial1 (TX=18, RX=19) → делитель → ESP32 (RX=16, TX=17)
- [ ] Mega2 Serial1 (TX=18, RX=19) → делитель → ESP32 (RX=5, TX=4)
- [ ] ESP32 GPIO23 → 330Ω → LED DI
- [ ] PSU1 12V → LED +12V (с инжекцией каждые 5м)
- [ ] Каждый реле модуль: VCC→5V, GND→GND, IN1→Mega pin UP, IN2→Mega pin DOWN
- [ ] Каждый реле модуль: COM1→Motor Red, COM2→Motor Black, NO1→+12V, NC1→GND, NO2→+12V, NC2→GND
- [ ] Актуаторы одного блока параллельно к одному реле модулю
- [ ] Предохранитель на каждый PSU→реле силовой выход
- [ ] Проверить Active LOW/HIGH реле модулей перед прошивкой
