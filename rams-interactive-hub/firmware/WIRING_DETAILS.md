# RAMS Kinetic Table — Детальная разводка по компонентам

---

## A. Блоки Питания (БП) — 5 штук, 12V 40A каждый

```
╔══════════════════════════════════════════════════════════════════════════╗
║                        POWER SUPPLY LAYOUT                              ║
║                                                                          ║
║   PSU 1 (Логика + LED)          PSU 2 (Актуаторы 1-4)                   ║
║   ┌────────────┐                ┌────────────┐                          ║
║   │ AC IN: 220V│                │ AC IN: 220V│                          ║
║   │            │                │            │                          ║
║   │ +12V ──────┼─► DC-DC 5V    │ +12V ──────┼─► Реле блоков 1,2,3,4   ║
║   │            │   (логика)     │            │   (через NO/NC)          ║
║   │            ├─► LED лента    │ GND ───────┼─► GND шина              ║
║   │ GND ───────┼─► GND шина    └────────────┘                          ║
║   └────────────┘                                                        ║
║                                                                          ║
║   PSU 3 (Актуаторы 5-8)        PSU 4 (Актуаторы 9-12)                  ║
║   ┌────────────┐                ┌────────────┐                          ║
║   │ +12V ──────┼─► Реле 5,6,7,8│ +12V ──────┼─► Реле 9,10,11,12       ║
║   │ GND ───────┼─► GND шина    │ GND ───────┼─► GND шина              ║
║   └────────────┘                └────────────┘                          ║
║                                                                          ║
║   PSU 5 (Актуаторы 13-15)                                              ║
║   ┌────────────┐                                                        ║
║   │ +12V ──────┼─► Реле 13,14,15                                       ║
║   │ GND ───────┼─► GND шина                                            ║
║   └────────────┘                                                        ║
║                                                                          ║
║   GND ШИНА (общая для ВСЕХ):                                            ║
║   ════╤════╤════╤════╤════                                              ║
║       │    │    │    │    │                                              ║
║     PSU1 PSU2 PSU3 PSU4 PSU5                                           ║
║                                                                          ║
║   ⚠️  Сечение GND шины: минимум 4мм² (лучше 6мм²)                      ║
║   ⚠️  Длина соединений между БП — минимальная                           ║
╚══════════════════════════════════════════════════════════════════════════╝
```

### PSU 1 — детально (Логика + LED)

```
PSU1 +12V ──┬──────────────────────────────────► LED лента +12V
            │                                     (инжекция каждые 5м)
            │
            └──► [DC-DC Buck 12V → 5V, 5A+]
                        │
                        ├──► Arduino Mega #1 (пин 5V)
                        ├──► Arduino Mega #2 (пин 5V)
                        ├──► ESP32 (пин VIN или 5V)
                        └──► Все 15 реле модулей VCC (5V)
                              (можно разделить на 2 DC-DC если не хватает)

PSU1 GND ───┬──► DC-DC GND
            ├──► LED лента GND
            ├──► Mega #1 GND
            ├──► Mega #2 GND
            ├──► ESP32 GND
            ├──► Все реле модули GND
            └──► GND ШИНА
```

> **Расчёт тока PSU1:**
> - DC-DC: Mega×2 (~100mA×2) + ESP32 (~250mA) + реле катушки (15×2×70mA = 2.1A) = **~2.65A на 5V** → DC-DC 5A хватит
> - LED лента 12V: ~40м × 30 LED/m × 20mA = ~24A при полном белом → **реально ~10-15A** при анимациях
> - **Итого PSU1: ~27A макс** — в пределах 40A

### PSU 2–5 — детально (Актуаторы)

```
PSU2 +12V ──┬──► Реле блока 1: NO1 и NC2 (через H-Bridge)
            ├──► Реле блока 2: NO1 и NC2
            ├──► Реле блока 3: NO1 и NC2
            └──► Реле блока 4: NO1 и NC2

PSU2 GND ───┬──► Реле блока 1: NC1 и NO2 (через H-Bridge)
            ├──► Реле блока 2: NC1 и NO2
            ├──► Реле блока 3: NC1 и NO2
            ├──► Реле блока 4: NC1 и NO2
            └──► GND ШИНА
```

(PSU3, PSU4, PSU5 — аналогично для своих блоков)

---

## B. Реле модули — 15 штук (2-канальные, 5V, 10A)

### Схема одного реле модуля (H-Bridge конфигурация)

```
                              RELAY MODULE (2-Channel)
                    ┌──────────────────────────────────────┐
     5V (DC-DC) ──► │ VCC                                  │
     GND ─────────► │ GND                                  │
                    │                                      │
  Mega Pin UP ────► │ IN1          RELAY 1                 │
                    │         ┌─────────────────┐          │
                    │         │ COM1 ──► Motor Wire A      │◄── К актуатору
                    │         │ NO1  ◄── +12V (PSU)        │◄── От БП
                    │         │ NC1  ◄── GND  (PSU)        │◄── От БП
                    │         └─────────────────┘          │
                    │                                      │
  Mega Pin DOWN ──► │ IN2          RELAY 2                 │
                    │         ┌─────────────────┐          │
                    │         │ COM2 ──► Motor Wire B      │◄── К актуатору
                    │         │ NO2  ◄── +12V (PSU)        │◄── От БП
                    │         │ NC2  ◄── GND  (PSU)        │◄── От БП
                    │         └─────────────────┘          │
                    └──────────────────────────────────────┘
```

### Пример: Блок 1 (2 актуатора, Mega #1, PSU 2)

```
                        Реле модуль #1
                   ┌─────────────────────┐
  Mega#1 Pin 22 ─► │ IN1                 │
  Mega#1 Pin 23 ─► │ IN2                 │
  DC-DC 5V ──────► │ VCC                 │
  GND ───────────► │ GND                 │
                   │                     │
  PSU2 +12V ─────► │ NO1    COM1 ────────┼──┬── Actuator 1A Red Wire
  PSU2 GND ──────► │ NC1                 │  └── Actuator 1B Red Wire
                   │                     │
  PSU2 +12V ─────► │ NO2    COM2 ────────┼──┬── Actuator 1A Black Wire
  PSU2 GND ──────► │ NC2                 │  └── Actuator 1B Black Wire
                   └─────────────────────┘
```

### Пример: Блок 15 / Центр (3 актуатора, Mega #2, PSU 5)

```
                        Реле модуль #15
                   ┌─────────────────────┐
  Mega#2 Pin 34 ─► │ IN1                 │
  Mega#2 Pin 35 ─► │ IN2                 │
  DC-DC 5V ──────► │ VCC                 │
  GND ───────────► │ GND                 │
                   │                     │
  PSU5 +12V ─────► │ NO1    COM1 ────────┼──┬── Actuator 15A Red
  PSU5 GND ──────► │ NC1                 │  ├── Actuator 15B Red
                   │                     │  └── Actuator 15C Red
  PSU5 +12V ─────► │ NO2    COM2 ────────┼──┬── Actuator 15A Black
  PSU5 GND ──────► │ NC2                 │  ├── Actuator 15B Black
                   └─────────────────────┘  └── Actuator 15C Black

  ⚠️ 3 актуатора параллельно = до 9A пиковый ток
     Реле рассчитано на 10A — на пределе!
     Рекомендуется предохранитель 10A на этот модуль
```

### Полная таблица: какой реле к какому Mega, PSU, блоку

| Реле # | Block | Mega | IN1 (UP) | IN2 (DOWN) | PSU  | Актуаторов | Макс ток |
|--------|-------|------|----------|------------|------|-----------|----------|
| 1      | 1     | #1   | Pin 22   | Pin 23     | PSU2 | 2         | ~6A      |
| 2      | 2     | #1   | Pin 24   | Pin 25     | PSU2 | 2         | ~6A      |
| 3      | 3     | #1   | Pin 26   | Pin 27     | PSU2 | 2         | ~6A      |
| 4      | 4     | #1   | Pin 28   | Pin 29     | PSU2 | 2         | ~6A      |
| 5      | 5     | #1   | Pin 30   | Pin 31     | PSU3 | 2         | ~6A      |
| 6      | 6     | #1   | Pin 32   | Pin 33     | PSU3 | 2         | ~6A      |
| 7      | 7     | #1   | Pin 34   | Pin 35     | PSU3 | 2         | ~6A      |
| 8      | 8     | #1   | Pin 36   | Pin 37     | PSU3 | 2         | ~6A      |
| 9      | 9     | #2   | Pin 22   | Pin 23     | PSU4 | 2         | ~6A      |
| 10     | 10    | #2   | Pin 24   | Pin 25     | PSU4 | 2         | ~6A      |
| 11     | 11    | #2   | Pin 26   | Pin 27     | PSU4 | 2         | ~6A      |
| 12     | 12    | #2   | Pin 28   | Pin 29     | PSU4 | 2         | ~6A      |
| 13     | 13    | #2   | Pin 30   | Pin 31     | PSU5 | 2         | ~6A      |
| 14     | 14    | #2   | Pin 32   | Pin 33     | PSU5 | 2         | ~6A      |
| 15     | 15    | #2   | Pin 34   | Pin 35     | PSU5 | 3         | ~9A ⚠️   |

---

## C. Актуаторы — 31 штука (линейные, 12V)

### Подключение одного актуатора

```
Актуатор (2 провода):
  ┌─────────────┐
  │  Red Wire   │──► К Relay COM1 (Motor Wire A)
  │             │
  │  Black Wire │──► К Relay COM2 (Motor Wire B)
  └─────────────┘

  Полярность:
  Red = +12V, Black = GND  → Выдвигается (UP)
  Red = GND, Black = +12V  → Втягивается (DOWN)
  Red = GND, Black = GND   → Стоит (STOP)
```

### Параллельное подключение (2 актуатора в блоке)

```
Relay COM1 ──┬── Actuator A Red ──[Actuator A]── Actuator A Black ──┬── Relay COM2
             │                                                       │
             └── Actuator B Red ──[Actuator B]── Actuator B Black ──┘
```

### Распределение актуаторов по блокам

| Block | Кольцо     | Акт. ID     | К реле # |
|-------|------------|-------------|----------|
| 1     | Внешнее    | A1, A2      | Реле 1   |
| 2     | Внешнее    | A3, A4      | Реле 2   |
| 3     | Внешнее    | A5, A6      | Реле 3   |
| 4     | Внешнее    | A7, A8      | Реле 4   |
| 5     | Внешнее    | A9, A10     | Реле 5   |
| 6     | Внешнее    | A11, A12    | Реле 6   |
| 7     | Внешнее    | A13, A14    | Реле 7   |
| 8     | Внутреннее | A15, A16    | Реле 8   |
| 9     | Внутреннее | A17, A18    | Реле 9   |
| 10    | Внутреннее | A19, A20    | Реле 10  |
| 11    | Внутреннее | A21, A22    | Реле 11  |
| 12    | Внутреннее | A23, A24    | Реле 12  |
| 13    | Внутреннее | A25, A26    | Реле 13  |
| 14    | Внутреннее | A27, A28    | Реле 14  |
| 15    | Центр      | A29,A30,A31 | Реле 15  |

---

## D. ESP32 — подключение

```
                         ESP32 DevKit
                    ┌─────────────────────┐
                    │                     │
      WiFi ◄───────│ (internal antenna)  │
                    │                     │
  DC-DC 5V ──────► │ VIN (or 5V)         │
  GND ───────────► │ GND                 │
                    │                     │
                    │ GPIO 17 (TX) ───────┼──► Mega #1 RX1 (pin 19)
  Mega#1 TX1 ──┐   │ GPIO 16 (RX) ◄─────┼──┐
    (pin 18)   │   │                     │  │
      [2.2kΩ]──┤   │                     │  │ (через делитель)
               ├───┼─────────────────────┼──┘
      [3.3kΩ]──┤   │                     │
         GND───┘   │                     │
                    │ GPIO 4  (TX) ───────┼──► Mega #2 RX1 (pin 19)
  Mega#2 TX1 ──┐   │ GPIO 5  (RX) ◄─────┼──┐
    (pin 18)   │   │                     │  │
      [2.2kΩ]──┤   │                     │  │ (через делитель)
               ├───┼─────────────────────┼──┘
      [3.3kΩ]──┤   │                     │
         GND───┘   │                     │
                    │ GPIO 23 ───[330Ω]──┼──► LED Strip Data In
                    │                     │
                    │ GPIO 2  (onboard)  │  Status LED
                    └─────────────────────┘
```

---

## E. Arduino Mega #1 — подключение

```
                      Arduino Mega #1
                 ┌────────────────────────┐
  DC-DC 5V ───► │ 5V                     │
  GND ────────► │ GND                    │
                │                        │
  ESP32 TX ───► │ RX1 (pin 19)           │  Serial1 от ESP32
                │ TX1 (pin 18) ──────────┼──► [делитель] ──► ESP32 RX
                │                        │
                │ Pin 22 ────────────────┼──► Реле 1 IN1 (Block 1 UP)
                │ Pin 23 ────────────────┼──► Реле 1 IN2 (Block 1 DOWN)
                │ Pin 24 ────────────────┼──► Реле 2 IN1 (Block 2 UP)
                │ Pin 25 ────────────────┼──► Реле 2 IN2 (Block 2 DOWN)
                │ Pin 26 ────────────────┼──► Реле 3 IN1 (Block 3 UP)
                │ Pin 27 ────────────────┼──► Реле 3 IN2 (Block 3 DOWN)
                │ Pin 28 ────────────────┼──► Реле 4 IN1 (Block 4 UP)
                │ Pin 29 ────────────────┼──► Реле 4 IN2 (Block 4 DOWN)
                │ Pin 30 ────────────────┼──► Реле 5 IN1 (Block 5 UP)
                │ Pin 31 ────────────────┼──► Реле 5 IN2 (Block 5 DOWN)
                │ Pin 32 ────────────────┼──► Реле 6 IN1 (Block 6 UP)
                │ Pin 33 ────────────────┼──► Реле 6 IN2 (Block 6 DOWN)
                │ Pin 34 ────────────────┼──► Реле 7 IN1 (Block 7 UP)
                │ Pin 35 ────────────────┼──► Реле 7 IN2 (Block 7 DOWN)
                │ Pin 36 ────────────────┼──► Реле 8 IN1 (Block 8 UP)
                │ Pin 37 ────────────────┼──► Реле 8 IN2 (Block 8 DOWN)
                └────────────────────────┘
                Использовано: 16 пинов + Serial1
```

---

## F. Arduino Mega #2 — подключение

```
                      Arduino Mega #2
                 ┌────────────────────────┐
  DC-DC 5V ───► │ 5V                     │
  GND ────────► │ GND                    │
                │                        │
  ESP32 TX ───► │ RX1 (pin 19)           │  Serial1 от ESP32
                │ TX1 (pin 18) ──────────┼──► [делитель] ──► ESP32 RX
                │                        │
                │ Pin 22 ────────────────┼──► Реле 9  IN1 (Block 9  UP)
                │ Pin 23 ────────────────┼──► Реле 9  IN2 (Block 9  DOWN)
                │ Pin 24 ────────────────┼──► Реле 10 IN1 (Block 10 UP)
                │ Pin 25 ────────────────┼──► Реле 10 IN2 (Block 10 DOWN)
                │ Pin 26 ────────────────┼──► Реле 11 IN1 (Block 11 UP)
                │ Pin 27 ────────────────┼──► Реле 11 IN2 (Block 11 DOWN)
                │ Pin 28 ────────────────┼──► Реле 12 IN1 (Block 12 UP)
                │ Pin 29 ────────────────┼──► Реле 12 IN2 (Block 12 DOWN)
                │ Pin 30 ────────────────┼──► Реле 13 IN1 (Block 13 UP)
                │ Pin 31 ────────────────┼──► Реле 13 IN2 (Block 13 DOWN)
                │ Pin 32 ────────────────┼──► Реле 14 IN1 (Block 14 UP)
                │ Pin 33 ────────────────┼──► Реле 14 IN2 (Block 14 DOWN)
                │ Pin 34 ────────────────┼──► Реле 15 IN1 (Block 15 UP)
                │ Pin 35 ────────────────┼──► Реле 15 IN2 (Block 15 DOWN)
                └────────────────────────┘
                Использовано: 14 пинов + Serial1
```

---

## G. LED лента WS2812B 12V — подключение

```
ESP32                        LED Strip (~40м, ~900 LEDs)
GPIO 23 ──[330Ω]──► DI ═══[Segment 0]═══[Segment 1]═══ ... ═══[Segment 16]══► DO (не подключен)
                     │                    │                      │
PSU1 +12V ───────────┤                    │                      │
                     │    ИНЖЕКЦИЯ 12V    │    ИНЖЕКЦИЯ 12V      │
PSU1 +12V ───────────┼────────────────────┤                      │
PSU1 +12V ───────────┼────────────────────┼──────────────────────┤
                     │                    │                      │
PSU1 GND ────────────┴────────────────────┴──────────────────────┘

⚠️ ИНЖЕКЦИЯ: подавать +12V и GND каждые ~5 метров
   чтобы избежать падения напряжения и тусклости

⚠️ DATA LINE: максимальная длина от ESP32 до первого LED — до 1м
   Если больше — использовать буфер (74HCT245)
```

---

## H. ОБЩАЯ СХЕМА (все вместе)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              220V AC MAINS                                     │
│   ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐                                │
│   │PSU 1│  │PSU 2│  │PSU 3│  │PSU 4│  │PSU 5│                                │
│   │12V  │  │12V  │  │12V  │  │12V  │  │12V  │                                │
│   └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘                                │
│      │        │        │        │        │                                     │
│  ════╧════════╧════════╧════════╧════════╧════  GND BUS (6мм²)                │
│      │                                                                        │
│      ├──► [DC-DC 5V]──┬──► ESP32                                              │
│      │                ├──► Mega #1                                             │
│      │                ├──► Mega #2                                             │
│      │                └──► Реле VCC (все 15)                                   │
│      │                                                                        │
│      └──► LED Strip (12V, ~40м)                                               │
│                                                                               │
│                  ┌─────────┐                                                   │
│                  │  ESP32  │                                                   │
│                  │         │                                                   │
│           WiFi◄──│    GPIO23──►LED                                             │
│                  │    TX17──────────────────────────────►Mega#1 RX19            │
│                  │    RX16◄──[делитель]◄────────────────Mega#1 TX18            │
│                  │    TX4───────────────────────────────►Mega#2 RX19            │
│                  │    RX5◄───[делитель]◄────────────────Mega#2 TX18            │
│                  └─────────┘                                                   │
│                                                                               │
│  ┌──────────────────────────┐    ┌──────────────────────────┐                  │
│  │      Arduino Mega #1     │    │      Arduino Mega #2     │                  │
│  │                          │    │                          │                  │
│  │  Pin 22-37 (16 пинов)   │    │  Pin 22-35 (14 пинов)   │                  │
│  │       │                  │    │       │                  │                  │
│  └───────┼──────────────────┘    └───────┼──────────────────┘                  │
│          │                               │                                     │
│          ▼                               ▼                                     │
│  ┌───────────────────┐           ┌───────────────────┐                         │
│  │ Реле 1-8          │           │ Реле 9-15         │                         │
│  │ (Blocks 1-8)      │           │ (Blocks 9-15)     │                         │
│  │                   │           │                   │                         │
│  │ H-Bridge config:  │           │ H-Bridge config:  │                         │
│  │ NO→+12V, NC→GND   │           │ NO→+12V, NC→GND   │                         │
│  │ COM→Motor wires   │           │ COM→Motor wires   │                         │
│  └───────┬───────────┘           └───────┬───────────┘                         │
│          │                               │                                     │
│          ▼                               ▼                                     │
│  ┌───────────────────┐           ┌───────────────────┐                         │
│  │ Actuators 1-16    │           │ Actuators 17-31   │                         │
│  │ (Blocks 1-8)      │           │ (Blocks 9-15)     │                         │
│  │ PSU 2,3           │           │ PSU 4,5           │                         │
│  └───────────────────┘           └───────────────────┘                         │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## I. Порядок включения системы

1. **Включить все 5 БП** (AC 220V)
2. DC-DC запитает логику → Mega×2 + ESP32 загрузятся
3. ESP32 подключится к WiFi
4. ESP32 начнёт LED idle-анимацию
5. ESP32 начнёт heartbeat с обоими Mega (каждые 2 сек)
6. Windows-приложение обнаружит ESP32 по UDP broadcast / фиксированному IP
7. Система готова к работе

## J. Порядок выключения

1. Отправить `ALL:STOP` из приложения
2. Дождаться подтверждения `ACK` от обоих Mega
3. Выключить БП
4. **Никогда** не выключать БП при работающих актуаторах — механические повреждения

---

## K. Troubleshooting

| Симптом                          | Причина                           | Решение                          |
|----------------------------------|-----------------------------------|----------------------------------|
| Реле щёлкает но актуатор стоит   | Нет 12V на NO/NC реле             | Проверить PSU и проводку         |
| Актуатор едет только в одну сторону | Один канал реле не работает    | Проверить IN2 пин и проводку     |
| LED лента тусклая в конце        | Падение напряжения                | Добавить инжекцию 12V            |
| ESP32 не видит WiFi              | Антенна / расстояние              | Поднести роутер / внешняя антенна|
| Mega не отвечает                 | Serial не подключен               | Проверить TX/RX/делитель         |
| Все реле включаются при старте   | Active LOW модули                 | Инвертировать логику в коде      |
| БП уходит в защиту               | Перегрузка / КЗ                   | Проверить нагрузку, предохранители|
