# Подключение 12V оборудования - RAMS Interactive Hub

## Обзор

У вас есть:
- ✅ ESP32 (3.3V логика)
- ✅ WS2812B LED ленты 12V
- ✅ Актуаторы 12V (линейные приводы)
- ✅ Реле для 12V нагрузки

**ВАЖНО**: 12V WS2812B отличается от 5V версии!

---

## Различия 12V vs 5V WS2812B

### 12V WS2812B (WS2811)

```
Характеристики:
- Напряжение: DC 12V
- Тип: 3 LED на 1 IC чип
- Адресация: Каждые 3 LED = 1 адрес
- Маркировка: WS2811, WS2812B-12V
- Провода: +12V (красный), GND (черный), DATA (зеленый/белый)
```

### Пример адресации

```
┌─────────┬─────────┬─────────┐
│ LED 0   │ LED 1   │ LED 2   │  → Адрес 0 (контролирует все 3 LED)
└─────────┴─────────┴─────────┘
┌─────────┬─────────┬─────────┐
│ LED 3   │ LED 4   │ LED 5   │  → Адрес 1 (контролирует все 3 LED)
└─────────┴─────────┴─────────┘
```

**В коде**: Если у вас 300 физических LED, то адресов будет 100 (300/3)

---

## Схема подключения

### Полная система

```
┌─────────────────────────────────────────────────────────────┐
│                          БП 12V / 10A                        │
│                     (для LED и актуаторов)                   │
└────┬──────────────────────────┬──────────────────────────┬──┘
     │                          │                          │
     │ +12V                     │ +12V                     │ +12V
     │                          │                          │
┌────▼──────────────┐   ┌───────▼─────────┐   ┌──────────▼────────┐
│  WS2812B LED      │   │  Relay Module   │   │  H-Bridge Module  │
│  12V Strip        │   │  (5V logic)     │   │  (L298N)          │
│                   │   │                 │   │                   │
│  DATA IN ◄────────┼───┼─ GPIO 16       │   │  IN1 ◄─ GPIO 21   │
│  +12V             │   │  Relay IN ◄────┼───┼─ GPIO 17/18/19    │
│  GND              │   │  +5V           │   │  +12V             │
└───────────────────┘   │  GND           │   │  GND              │
                        └────┬────────────┘   │  OUT1,2 → Actuator│
                             │                └───────────────────┘
                   ┌─────────▼─────────┐
                   │    ESP32          │
                   │                   │
                   │  GPIO 16 (DATA)   │
                   │  GPIO 17,18,19    │
                   │  GPIO 21,22       │
                   │                   │
                   │  5V ◄─── USB      │
                   │  GND ──┬──────────┼──── Общая земля!
                   └────────┼──────────┘
                            │
                     ┌──────▼──────┐
                     │   БП 5V     │
                     │   USB / DC  │
                     └─────────────┘
```

---

## Детальное подключение компонентов

### 1. ESP32 к WS2812B (12V)

#### Проблема: Level Shifting

ESP32 работает на **3.3V логике**, а WS2812B-12V ожидает **5V логику**.

#### Решения:

**Вариант A: Level Shifter (рекомендуется)**

```
ESP32 GPIO16 (3.3V) ──┐
                       ├──► Level Shifter 74HCT125 ──► WS2812B DATA
ESP32 GND ─────────────┘                                     │
                                                            GND
+12V БП ──────────────────────────────────────────► WS2812B +12V
GND (общая земля) ────────────────────────────────► WS2812B GND
```

**Микросхемы для Level Shifting:**
- 74HCT125 (Buffer)
- 74AHCT125
- SN74AHCT1G125
- TXS0108E (Bidirectional, 8-channel)

**Вариант B: Резистор (работает не всегда)**

```
ESP32 GPIO16 ───[470Ω]───► WS2812B DATA
```

> ⚠️ Может работать на коротких расстояниях (< 1 метр), но не гарантировано.

**Вариант C: Первый LED как буфер**

Используйте первый LED (адрес 0) как "жертвенный" буфер:
- Физически первый LED может не работать корректно
- Но он усилит сигнал для остальных
- В коде просто игнорируйте LED 0

#### Пример подключения с 74HCT125:

```
                   ┌────────────┐
ESP32 GPIO16 ──────┤1  /OE   14├───── +5V (от USB или DC-DC)
                   │           │
GND ───────────────┤2   A    Y ├13──► WS2812B DATA IN
                   │           │
                   │  74HCT125 │
                   │           │
GND ───────────────┤7   GND VCC├14──── +5V
                   └────────────┘
```

**Где купить Level Shifter:**
- AliExpress: "74HCT125 Module"
- Amazon: "Logic Level Converter 3.3V to 5V"
- Локально: магазины радиодеталей

---

### 2. Подключение LED ленты

#### Питание 12V

```
Блок питания 12V (минимум 5A):
  (+12V RED)   ───────► WS2812B Red Wire (+12V)
  (GND BLACK)  ───────► WS2812B Black Wire (GND)
                   ├──► ESP32 GND (ОБЩАЯ ЗЕМЛЯ!)
```

**Расчет мощности:**

```
Формула: P = V × I

Для 12V WS2812B:
- 1 сегмент (3 LED) = ~0.24W при полной яркости
- 100 сегментов (300 LED) = 24W → минимум 2A
- 200 сегментов (600 LED) = 48W → минимум 4A

Рекомендуется БП на 20-30% больше:
  300 LED → БП 12V/3A
  600 LED → БП 12V/5-6A
  1000 LED → БП 12V/10A
```

#### Защита цепи

1. **Конденсатор на входе питания LED**:
   ```
   +12V ──┬──[1000μF]──┬──► LED Strip
         │             │
        GND ───────────┘
   ```
   - Защищает от скачков напряжения
   - Уменьшает шум

2. **Предохранитель**:
   ```
   +12V ──[Fuse 5A]──► LED Strip
   ```

---

### 3. Реле модули (12V нагрузка)

#### Тип реле: 5V логика, 12V коммутация

```
┌──────────────────────────────────────┐
│       Relay Module (4-channel)       │
│                                      │
│  IN1 ◄───── GPIO 17 (3.3V)          │
│  IN2 ◄───── GPIO 18 (3.3V)          │
│  IN3 ◄───── GPIO 19 (3.3V)          │
│  IN4 ◄───── (резерв)                │
│                                      │
│  VCC ◄───── +5V (от USB ESP32)       │
│  GND ◄───── GND (общая земля)        │
│                                      │
│  COM  ◄──── +12V (БП)                │
│  NO   ───► 12V Lamp / Fan            │
│  NC   (не используется)              │
└──────────────────────────────────────┘
```

**ВАЖНО**:
- Большинство реле модулей **активны LOW** (срабатывают при 0V на IN)
- В коде: `digitalWrite(RELAY_PIN, LOW)` = включить
- `digitalWrite(RELAY_PIN, HIGH)` = выключить

#### Подключение нагрузки

```
+12V БП ──┬──► Relay COM (канал 1)
         │
         │    Relay NO ──► (+) LED Strip / Lamp
         │                    │
         │                   (-)
         └──────────────────► GND БП
```

---

### 4. Актуаторы 12V (Linear Actuators)

Для управления направлением нужен **H-Bridge** (например, L298N).

#### Подключение L298N H-Bridge

```
┌────────────────────────────────────────────┐
│              L298N H-Bridge                │
│                                            │
│  IN1 ◄───── GPIO 21 (Actuator Forward)    │
│  IN2 ◄───── GPIO 22 (Actuator Reverse)    │
│  IN3 ◄───── (опционально - 2й актуатор)   │
│  IN4 ◄───── (опционально - 2й актуатор)   │
│                                            │
│  +12V ◄──── +12V БП                        │
│  GND  ◄──── GND (общая земля)              │
│  +5V  ───► (не подключать к ESP32!)       │
│                                            │
│  OUT1,2 ──► Actuator Motor A              │
│  OUT3,4 ──► Actuator Motor B (опционально)│
└────────────────────────────────────────────┘
```

#### Логика управления актуатором

| IN1 | IN2 | Действие              |
|-----|-----|-----------------------|
| LOW | LOW | Стоп                  |
| HIGH| LOW | Вперед (вверх)        |
| LOW |HIGH | Назад (вниз)          |
| HIGH|HIGH | Тормоз (не рекомендуется) |

**В коде:**

```cpp
// Вверх
digitalWrite(ACTUATOR_UP_PIN, HIGH);   // GPIO 21
digitalWrite(ACTUATOR_DOWN_PIN, LOW);  // GPIO 22

// Вниз
digitalWrite(ACTUATOR_UP_PIN, LOW);
digitalWrite(ACTUATOR_DOWN_PIN, HIGH);

// Стоп
digitalWrite(ACTUATOR_UP_PIN, LOW);
digitalWrite(ACTUATOR_DOWN_PIN, LOW);
```

#### Защита актуатора

1. **Концевые выключатели** (End Stops):
   - Физические кнопки на концах хода
   - Предотвращают перегрузку мотора

2. **Timeout в коде**:
   ```cpp
   actuators[0].moveDuration = 5000;  // 5 секунд максимум
   ```

3. **Диоды обратной полярности**:
   - L298N имеет встроенные диоды
   - Защищают от обратного тока

---

## Питание системы

### Схема питания

```
┌─────────────────────────────────────────────────────────┐
│                 Общая схема питания                     │
└─────────────────────────────────────────────────────────┘

┌──────────────┐              ┌──────────────┐
│   220V AC    │              │  12V DC БП   │
│   Розетка    ├─────────────►│   10A / 120W │
└──────────────┘              └──────┬───────┘
                                     │
                 ┌───────────────────┼──────────────────┐
                 │                   │                  │
            ┌────▼────┐         ┌───▼─────┐      ┌────▼─────┐
            │ ESP32   │         │ WS2812B │      │ Actuators│
            │ 5V USB  │         │ 12V     │      │ 12V      │
            └─────────┘         └─────────┘      └──────────┘
                 │                   │                 │
                 └───────────────────┴─────────────────┘
                              GND (Общая земля!)
```

### Рекомендуемые блоки питания

1. **Для LED (12V)**:
   - Мощность: 5-10A (60-120W)
   - Тип: Импульсный БП с защитой
   - Пример: "12V 10A Power Supply LED Strip"

2. **Для ESP32 (5V)**:
   - Мощность: 1-2A
   - Тип: USB адаптер или DC-DC converter
   - Можно использовать обычную зарядку для телефона

3. **Для актуаторов (12V)**:
   - Можно использовать общий БП с LED
   - Или отдельный БП 12V/5A для мощных актуаторов

### Общая земля (CRITICAL!)

```
              ┌─────────────────────────────┐
              │   ОБЩАЯ ЗЕМЛЯ (GND)         │
              ├─────────────────────────────┤
              │                             │
   ┌──────────┤  ● ESP32 GND                │
   │          │  ● БП 12V GND (-)           │
   │          │  ● WS2812B GND (черный)     │
   │          │  ● Relay GND                │
   │          │  ● H-Bridge GND             │
   │          │                             │
   └──────────┴─────────────────────────────┘

   ⚠️ Все устройства ДОЛЖНЫ иметь общую землю!
```

**Если земля не общая:**
- LED не будут работать
- Сигналы будут искажены
- Возможны сбои и повреждения

---

## Практическая установка

### Шаг 1: Подготовка компонентов

**Список покупок:**

| Компонент | Количество | Примечание |
|-----------|-----------|------------|
| ESP32 DevKit | 1 шт | Любая версия с WiFi |
| WS2812B LED 12V | 5-10 метров | Уточнить количество LED |
| БП 12V/10A | 1 шт | Для LED и актуаторов |
| БП 5V/2A USB | 1 шт | Для ESP32 |
| Level Shifter (74HCT125) | 1 шт | Для Data line |
| Relay Module 4-channel | 1 шт | 5V logic, 12V load |
| L298N H-Bridge | 1 шт | Для актуаторов |
| Linear Actuator 12V | 1-3 шт | По необходимости |
| Провода | - | Разные сечения |
| Предохранители | 2-3 шт | 5A, 10A |
| Конденсаторы 1000μF | 2 шт | Для стабилизации |

### Шаг 2: Монтаж

1. **Разместить компоненты на DIN-рейке или панели**
2. **Закрепить БП 12V**
3. **Установить ESP32 в корпус**
4. **Смонтировать реле и H-Bridge рядом**

### Шаг 3: Проводка

**Сечение проводов:**
- **Питание 12V (LED)**: 1.5-2.5 мм² (AWG 14-16)
- **Питание 12V (Actuators)**: 1.5-2.5 мм²
- **Сигналы (Data, GPIO)**: 0.5-0.75 мм² (AWG 20-22)
- **Земля (GND)**: 1.5 мм² минимум

**Цветовая маркировка:**
- Красный: +12V
- Черный: GND
- Зеленый/Белый: Data / Сигнал
- Синий: +5V

### Шаг 4: Тестирование

1. **Без подключения LED**:
   - Загрузить прошивку
   - Проверить Serial Monitor
   - Проверить WiFi подключение

2. **Подключить 1 сегмент (3 LED)**:
   - Тестировать Data line
   - Убедиться что LED загораются

3. **Подключить всю ленту**:
   - Постепенно добавлять сегменты
   - Проверять яркость

4. **Тестировать реле и актуаторы**:
   - Отправить команды через HTTP
   - Проверить срабатывание

---

## Конфигурация для 12V LED

### Обновление кода ESP32

```cpp
// В файле rams_controller.ino

// LED Configuration для 12V WS2812B
#define LED_PIN           16        // GPIO для Data
#define NUM_LEDS          200       // Количество АДРЕСОВ (не физических LED!)
                                    // Если 600 физических LED = 200 адресов
#define LED_TYPE          WS2811    // Для 12V используется WS2811
#define COLOR_ORDER       RGB       // Порядок цветов (может быть GRB)
#define BRIGHTNESS        200       // Яркость (0-255)

// Если нужна коррекция:
#define WS2811_CORRECTION TypicalLEDStrip
```

### Пример маппинга проектов

```cpp
void setupProjects() {
  // Пример для 600 физических LED (200 адресов)

  // RAMS BEYOND (id=0) - 45 LED (15 адресов)
  projects[0].ledStart = 0;
  projects[0].ledCount = 15;      // 15 адресов × 3 LED = 45 LED
  projects[0].color = CRGB::Gold;

  // RAMS CITY (id=1) - 30 LED (10 адресов)
  projects[1].ledStart = 15;
  projects[1].ledCount = 10;      // 10 адресов × 3 LED = 30 LED
  projects[1].color = CRGB::White;

  // RAMS GARDEN (id=9) - 90 LED (30 адресов)
  projects[9].ledStart = 50;
  projects[9].ledCount = 30;      // 30 адресов × 3 LED = 90 LED
  projects[9].color = CRGB::Green;
}
```

---

## Troubleshooting для 12V

### LED не работают

1. **Проверить напряжение**:
   - Измерить +12V на ленте (должно быть 11.8-12.3V)

2. **Проверить Data line**:
   - Использовать Level Shifter
   - Попробовать уменьшить расстояние

3. **Проверить тип LED**:
   - В коде указать `WS2811` вместо `WS2812B`

4. **Проверить количество адресов**:
   - NUM_LEDS = физические LED / 3

### LED мерцают

1. **Добавить конденсатор** 1000μF на питание
2. **Уменьшить яркость** (BRIGHTNESS = 150)
3. **Проверить качество БП** (пульсации < 5%)

### Некоторые LED не работают

1. **Проверить последовательность**:
   - DATA IN → DATA OUT (направление!)
2. **Тестировать сегментами**:
   - Найти проблемный сегмент
3. **Проверить пайку/коннекторы**

---

## Безопасность при работе с 12V

1. ✅ **Предохранители** на каждой линии 12V
2. ✅ **Общая земля** для всех устройств
3. ✅ **Изоляция** проводов и контактов
4. ✅ **Защита от КЗ** (short circuit)
5. ✅ **Вентиляция** для БП и H-Bridge
6. ⚠️ **Не касаться** контактов при включенном питании

---

## Дополнительные ресурсы

- **FastLED Wiki**: https://github.com/FastLED/FastLED/wiki
- **WS2811 vs WS2812B**: https://www.led-stuebchen.de/ws2811-vs-ws2812b
- **Level Shifters Guide**: https://learn.adafruit.com/logic-level-shifter
- **Linear Actuators Tutorial**: https://www.actuonix.com/support

---

**Дата**: 2026-01-27
**Версия**: 1.0
**Для проекта**: RAMS Interactive Hub
